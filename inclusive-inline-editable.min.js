/*! inclusive-inline-editable 0.0.1 — © Heydon Pickering */
(function(global){"use strict";function InlineEditable(editable,button,options){options=options||{};this.settings={allowHTML:true,allowedTags:["em","strong","a","span"],textareaMode:false,charLimit:false};for(var setting in options){if(options.hasOwnProperty(setting)){this.settings[setting]=options[setting]}}this.editButton=document.querySelector(button);this.editable=document.querySelector(editable);if(this.editable.contains(this.editButton)){throw new Error("InlineEditables cannot contain the buttons that control them.")}this.caretToEnd=function(){if(document.createRange){var range=document.createRange();range.selectNodeContents(this.editable);range.collapse(false);var selection=window.getSelection();selection.removeAllRanges();selection.addRange(range)}};this.editMode=false;this.keyConfirm=function(e){var key=e.which||e.keyCode||0;if(key===13&&!this.settings.textareaMode||key===83&&(e.ctrlKey||e.metaKey)){e.preventDefault();this.saveEdit();if(this.valid){this.editButton.focus()}}};this.createProxy=function(string){var proxyElem=document.createElement("span");proxyElem.innerHTML=string;return proxyElem};this.limitCheck=function(e){var proxy=this.createProxy(this.editable.textContent);var chars=proxy.textContent.length;if(chars>this.settings.charLimit){this._fire("limited",{editButton:this.editButton,editable:this.editable,charLimit:this.settings.charLimit});proxy=this.createProxy(this.editable.textContent);var toRemove=proxy.textContent.length-this.settings.charLimit;this.editable.textContent=this.editable.textContent.substring(0,this.editable.textContent.length-toRemove);this.caretToEnd()}};this.editable.addEventListener("keydown",this.keyConfirm.bind(this));this.editButton.addEventListener("click",this.toggleMode.bind(this));if(this.settings.charLimit){this.editable.addEventListener("input",this.limitCheck.bind(this))}this._listeners={}}InlineEditable.prototype.startEdit=function(){this.editable.setAttribute("contenteditable",true);this.editable.setAttribute("role","textbox");if(this.settings.textareaMode){this.editable.setAttribute("aria-multiline","true")}if(this.settings.allowHTML){this.editable.textContent=this.editable.innerHTML}this.caretToEnd();this.editable.focus();this.editMode=true;this._fire("startEdit",{editButton:this.editButton,editable:this.editable});return this};InlineEditable.prototype.saveEdit=function(){this.valid=true;var proxy=this.createProxy(this.editable.textContent);if(this.settings.allowHTML){var childElems=proxy.querySelectorAll("*");Array.prototype.forEach.call(childElems,function(childElem){console.log(this.settings.allowedTags.indexOf(childElem)<0);if(this.settings.allowedTags.indexOf(childElem.nodeName.toLowerCase())<0){this.valid=false;this._fire("disallowed",{editButton:this.editButton,editable:this.editable,badElement:childElem})}}.bind(this))}if(this.valid){this.editable.removeAttribute("contenteditable");this.editable.removeAttribute("role");if(this.settings.textareaMode){this.editable.removeAttribute("aria-multiline")}if(this.settings.allowHTML){this.editable.innerHTML=proxy.innerHTML}this.editMode=false;this._fire("saveEdit",{editButton:this.editButton,editable:this.editable})}return this};InlineEditable.prototype.toggleMode=function(){if(this.editMode){this.saveEdit()}else{this.startEdit()}return this};InlineEditable.prototype._fire=function(type,data){var listeners=this._listeners[type]||[];listeners.forEach(function(listener){listener(data)})};InlineEditable.prototype.on=function(type,handler){if(typeof this._listeners[type]==="undefined"){this._listeners[type]=[]}this._listeners[type].push(handler);return this};InlineEditable.prototype.off=function(type,handler){var index=this._listeners[type].indexOf(handler);if(index>-1){this._listeners[type].splice(index,1)}return this};InlineEditable.prototype.destroy=function(){this.editButton.removeEventListener("click",this.toggleMode);this.editable.removeEventListener("keydown",this.keyConfirm);this.editable.removeEventListener("input",this.limitCheck);this._listeners={};this._fire("destroy");return this};if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=InlineEditable}else if(typeof define==="function"&&define.amd){define("InlineEditable",[],function(){return InlineEditable})}else if(typeof global==="object"){global.InlineEditable=InlineEditable}})(this);
